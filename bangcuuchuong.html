<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MathHub — Bảng Cửu Chương (Pro)</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{
  --bg1: linear-gradient(135deg,#0f172a 0%, #0b1220 100%);
  --card:#ffffff;
  --accent:#6f42c1;
  --accent-2:#4e73df;
  --success:#16a34a;
  --danger:#ef4444;
  --muted:#6b7280;
  --glass: rgba(255,255,255,0.03);
  --glass-2: rgba(255,255,255,0.06);
  --radius:14px;
  --tran: all .22s ease;
  color-scheme: light;
}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
html,body{height:100%;margin:0;background:var(--bg1);color:#e6eef8}
a{color:inherit}
.container{width:100%;max-width:1150px;margin:28px auto;padding:20px;border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));box-shadow:0 20px 60px rgba(2,6,23,0.6);overflow:hidden}
.header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:20px}
.title h1{margin:0;font-size:1.25rem}
.title p{margin:0;color:var(--muted);font-size:0.9rem}
.header-controls{display:flex;gap:8px;align-items:center}
.btn{background:transparent;border:0;color:inherit;padding:8px 12px;border-radius:10px;cursor:pointer;transition:var(--tran);display:inline-flex;gap:8px;align-items:center}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;box-shadow:0 8px 20px rgba(79,70,229,0.12);font-weight:600}
.btn.ghost{background:var(--glass);border:1px solid rgba(255,255,255,0.04)}
.grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.table-select{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:12px}
@media (max-width:720px){.table-select{grid-template-columns:repeat(3,1fr)}}
.table-btn{padding:10px;border-radius:10px;border:0;background:linear-gradient(135deg,#0ea5e9,#3b82f6);color:white;font-weight:600;cursor:pointer;transition:var(--tran)}
.table-btn.secondary{background:linear-gradient(135deg,#f97316,#fb923c)}
.table-btn.large{padding:14px;font-size:1.05rem}
.table-btn.active{outline:3px solid rgba(99,102,241,0.16);transform:translateY(-4px);box-shadow:0 12px 30px rgba(79,70,229,0.12)}
.controls{display:flex;gap:8px;align-items:center;margin-top:12px}
.question-big{text-align:center;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));font-size:2rem;font-weight:700;margin:12px 0;min-height:78px;display:flex;align-items:center;justify-content:center}
.input-answer{width:180px;padding:12px;border-radius:12px;border:2px solid rgba(255,255,255,0.06);background:transparent;color:inherit;font-size:1.2rem;text-align:center}
.input-answer:focus{outline:none;box-shadow:0 8px 28px rgba(99,102,241,0.08);border-color:rgba(99,102,241,0.4)}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
.stat{padding:10px;border-radius:10px;background:var(--glass-2);text-align:center}
.stat .label{font-size:0.85rem;color:var(--muted)}
.stat .value{font-weight:700;font-size:1.3rem;margin-top:6px}
.small-muted{color:var(--muted);font-size:0.9rem}
.progress{height:12px;background:rgba(255,255,255,0.04);border-radius:12px;overflow:hidden;margin-top:8px}
.progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
.feedback{min-height:44px;margin-top:10px;border-radius:8px;padding:10px;font-weight:600;opacity:0;transform:translateY(6px);transition:var(--tran)}
.feedback.show{opacity:1;transform:translateY(0)}
.feedback.correct{background:rgba(16,185,129,0.08);color:var(--success);border:1px solid rgba(16,185,129,0.12)}
.feedback.wrong{background:rgba(239,68,68,0.06);color:var(--danger);border:1px solid rgba(239,68,68,0.10)}
.leaderboard{margin-top:12px}
.leaderboard ol{margin:0;padding-left:18px}
.kv{display:flex;justify-content:space-between}
.footer{margin-top:16px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}

/* accessible focus */
.table-btn:focus, .btn:focus, .input-answer:focus{outline:3px solid rgba(99,102,241,0.12)}

/* small screens */
@media (max-width:420px){
  .input-answer{width:120px}
  .table-select{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="container" role="application" aria-label="MathHub Bảng Cửu Chương Pro">
  <div class="header">
    <div class="brand">
      <div class="logo">MH</div>
      <div class="title">
        <h1>Bảng Cửu Chương — MathHub</h1>
        <p>Học, luyện, và thi thử — chuyên nghiệp cho giáo viên</p>
      </div>
    </div>
    <div class="header-controls">
      <button class="btn ghost" id="btn-import"><i class="fas fa-file-import"></i> Import</button>
      <button class="btn ghost" id="btn-export"><i class="fas fa-file-export"></i> Export CSV</button>
      <button class="btn ghost" id="btn-reset"><i class="fas fa-sync"></i> Reset</button>
      <button class="btn primary" id="btn-home"><i class="fas fa-home"></i> Trang chủ</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="small-muted">Chọn bảng hoặc 'Tổng hợp'</div>
      <div class="table-select" id="table-select">
        <button class="table-btn" data-table="2">2</button>
        <button class="table-btn" data-table="3">3</button>
        <button class="table-btn" data-table="4">4</button>
        <button class="table-btn" data-table="5">5</button>
        <button class="table-btn" data-table="6">6</button>
        <button class="table-btn" data-table="7">7</button>
        <button class="table-btn" data-table="8">8</button>
        <button class="table-btn" data-table="9">9</button>
        <button class="table-btn" data-table="10">10</button>
        <button class="table-btn secondary" data-table="mixed">Tổng hợp</button>
      </div>

      <div class="row">
        <div style="flex:1">
          <div class="question-big" id="question">Chọn bảng để bắt đầu</div>
          <div style="display:flex;justify-content:center;gap:8px;align-items:center">
            <input id="answer" class="input-answer" type="number" placeholder="Đáp án" aria-label="đáp án" disabled>
            <button class="btn primary" id="btn-check" disabled><i class="fas fa-check"></i> Kiểm tra</button>
            <button class="btn ghost" id="btn-skip" disabled><i class="fas fa-forward"></i> Bỏ qua</button>
          </div>
          <div id="feedback" class="feedback" role="status" aria-live="polite"></div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;align-items:center;justify-content:space-between">
        <div class="stats" style="flex:1">
          <div class="stat"><div class="label">Điểm</div><div class="value" id="score">0</div></div>
          <div class="stat"><div class="label">Đúng</div><div class="value" id="correct">0</div></div>
          <div class="stat"><div class="label">Bảng</div><div class="value" id="current">-</div></div>
        </div>
      </div>

      <div class="progress" aria-hidden="true"><i id="progressBar" style="width:0%"></i></div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <label class="small-muted">Số câu hoàn thành cho 1 bảng:</label>
        <select id="targetCount" class="input-answer" style="width:140px;height:auto;padding:8px">
          <option value="5">5</option><option value="10" selected>10</option><option value="20">20</option>
        </select>
      </div>
    </div>

    <div class="card" aria-label="Bảng điều khiển">
      <div class="small-muted">Cài đặt nhanh</div>
      <div style="margin-top:8px">
        <label class="small-muted">Chế độ</label>
        <select id="modeSelect" class="input-answer" style="width:100%">
          <option value="practice">Luyện tập (không giới hạn)</option>
          <option value="challenge">Thử thách (thời gian)</option>
        </select>
      </div>
      <div style="margin-top:8px">
        <label class="small-muted">Thời gian (giây) — chỉ chế độ thử thách</label>
        <input id="timeLimit" type="number" class="input-answer" value="60" min="10" style="width:100%">
      </div>

      <div style="margin-top:12px">
        <h4 style="margin:0 0 6px 0">BXH</h4>
        <div class="leaderboard card" style="padding:10px">
          <ol id="leaderboard"></ol>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn ghost" id="btn-export-csv"><i class="fas fa-file-csv"></i> Xuất CSV</button>
            <button class="btn ghost" id="btn-clear-lb"><i class="fas fa-trash"></i> Xóa BXH</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h4 style="margin:0 0 6px 0">Giao diện & Trợ năng</h4>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <label class="small-muted">Giảm hoạt ảnh</label>
          <input id="reducedMotion" type="checkbox" />
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <label class="small-muted">Bật âm</label>
          <input id="soundToggle" type="checkbox" checked />
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="small-muted">Phiên bản Pro — MathHub | Giáo viên: Thầy Chương</div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn ghost" id="btn-print"><i class="fas fa-print"></i> In</button>
      <button class="btn primary" id="btn-save">Lưu tiến trình</button>
    </div>
  </div>
</div>

<script>
/* Professional multiplication table game - Optimized version
   Optimizations:
   - Event delegation for better performance
   - Debounced event handlers
   - Optimized DOM updates
   - Improved error handling
   - Better state management
*/
(() => {
  // State
  const state = {
    table: null,
    question: null,
    score: 0,
    correct: 0,
    answeredCount: 0,
    target: Number(document.getElementById('targetCount')?.value || 10),
    mode: 'practice',
    timeLimit: Number(document.getElementById('timeLimit')?.value || 60),
    timeLeft: null,
    timer: null,
    waiting: false,
    asked: new Set(),
    reducedMotion: false,
    soundOn: true
  };

  // DOM references with caching
  const dom = {
    tableSelect: document.getElementById('table-select'),
    question: document.getElementById('question'),
    answer: document.getElementById('answer'),
    btnCheck: document.getElementById('btn-check'),
    btnSkip: document.getElementById('btn-skip'),
    score: document.getElementById('score'),
    correct: document.getElementById('correct'),
    current: document.getElementById('current'),
    progressBar: document.getElementById('progressBar'),
    feedback: document.getElementById('feedback'),
    targetCount: document.getElementById('targetCount'),
    modeSelect: document.getElementById('modeSelect'),
    timeLimit: document.getElementById('timeLimit'),
    leaderboard: document.getElementById('leaderboard'),
    btnHome: document.getElementById('btn-home'),
    btnExportCSV: document.getElementById('btn-export'),
    btnImport: document.getElementById('btn-import'),
    btnReset: document.getElementById('btn-reset'),
    btnExportLB: document.getElementById('btn-export-csv'),
    btnClearLB: document.getElementById('btn-clear-lb'),
    btnSave: document.getElementById('btn-save'),
    btnPrint: document.getElementById('btn-print'),
    reducedMotion: document.getElementById('reducedMotion'),
    soundToggle: document.getElementById('soundToggle')
  };

  // Audio context - lazy initialization
  let audioCtx = null;
  
  // Utility functions
  const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
  
  const debounce = (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  };

  // LocalStorage operations with error handling
  const safeLocalStorage = {
    getItem: (key) => {
      try {
        return localStorage.getItem(key);
      } catch (e) {
        console.error('Error accessing localStorage:', e);
        return null;
      }
    },
    
    setItem: (key, value) => {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch (e) {
        console.error('Error writing to localStorage:', e);
        return false;
      }
    },
    
    removeItem: (key) => {
      try {
        localStorage.removeItem(key);
        return true;
      } catch (e) {
        console.error('Error removing from localStorage:', e);
        return false;
      }
    }
  };

  // Audio functions
  const ensureAudio = () => {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
  };

  const playTone = (freqs = [440], dur = 0.12) => {
    if (!state.soundOn) return;
    
    try {
      ensureAudio();
      const now = audioCtx.currentTime;
      const gainNode = audioCtx.createGain();
      
      gainNode.gain.setValueAtTime(0.001, now);
      gainNode.gain.exponentialRampToValueAtTime(0.2, now + 0.02);
      gainNode.gain.exponentialRampToValueAtTime(0.0001, now + dur);
      gainNode.connect(audioCtx.destination);
      
      freqs.forEach((freq, i) => {
        const oscillator = audioCtx.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(freq, now + i * 0.02);
        oscillator.connect(gainNode);
        oscillator.start(now + i * 0.02);
        oscillator.stop(now + dur + i * 0.02);
      });
    } catch (e) {
      console.log('Audio not supported', e);
    }
  };

  // Leaderboard functions
  const saveLB = (list) => {
    safeLocalStorage.setItem('mh_lbh', JSON.stringify(list));
  };

  const loadLB = () => {
    const data = safeLocalStorage.getItem('mh_lbh');
    return data ? JSON.parse(data) : [];
  };

  const renderLB = () => {
    const list = loadLB();
    dom.leaderboard.innerHTML = '';
    
    list.slice(0, 10).forEach((item, index) => {
      const li = document.createElement('li');
      li.innerHTML = `<span>${index + 1}. <strong>${item.name}</strong></span><span>${item.score}</span>`;
      dom.leaderboard.appendChild(li);
    });
  };

  const exportLBCSV = () => {
    const list = loadLB();
    if (!list.length) {
      alert('BXH trống');
      return;
    }
    
    const rows = [['rank', 'name', 'score', 'date']].concat(
      list.map((item, index) => [index + 1, item.name, item.score, item.date])
    );
    
    const csvContent = rows.map(row => 
      row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
    ).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    
    link.href = url;
    link.download = 'mathhub_leaderboard.csv';
    link.click();
    
    URL.revokeObjectURL(url);
  };

  const clearLB = () => {
    if (confirm('Xóa BXH?')) {
      safeLocalStorage.removeItem('mh_lbh');
      renderLB();
    }
  };

  // Game state management
  const saveProgress = () => {
    const progressData = {
      table: state.table,
      score: state.score,
      correct: state.correct,
      answeredCount: state.answeredCount
    };
    
    if (safeLocalStorage.setItem('mh_progress', JSON.stringify(progressData))) {
      alert('Đã lưu tiến trình vào localStorage');
    } else {
      alert('Không thể lưu tiến trình');
    }
  };

  const loadProgress = () => {
    const data = safeLocalStorage.getItem('mh_progress');
    if (!data) {
      alert('Không có tiến trình');
      return;
    }
    
    try {
      const progress = JSON.parse(data);
      state.table = progress.table;
      state.score = progress.score;
      state.correct = progress.correct;
      state.answeredCount = progress.answeredCount;
      
      updateUI();
      if (state.table) {
        activateButtonForTable(state.table);
      }
      
      alert('Đã tải tiến trình');
    } catch (e) {
      console.error('Error loading progress:', e);
      alert('Lỗi khi tải tiến trình');
    }
  };

  // Table activation
  const activateButtonForTable = (table) => {
    // Update button states
    document.querySelectorAll('.table-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.table === table);
    });
    
    // Update game state
    state.table = table;
    state.asked.clear();
    state.answeredCount = 0;
    state.target = Number(dom.targetCount.value) || 10;
    state.mode = dom.modeSelect.value;
    state.timeLimit = Number(dom.timeLimit.value) || 60;
    
    // Update UI
    dom.current.textContent = table === 'mixed' ? 'Tổng hợp' : `Bảng ${table}`;
    dom.answer.disabled = false;
    dom.btnCheck.disabled = false;
    dom.btnSkip.disabled = false;
    
    // Focus and start
    dom.answer.focus();
    newQuestion();
  };

  // Question generation
  const newQuestion = () => {
    if (!state.table) return;
    
    let a, b, key;
    let attempts = 0;
    
    // Generate a unique question
    do {
      if (state.table === 'mixed') {
        a = randInt(2, 10);
        b = randInt(1, 10);
      } else {
        a = Number(state.table);
        b = randInt(1, 10);
      }
      
      key = `${a}x${b}`;
      attempts++;
      
      // Reset asked set if too many attempts
      if (attempts > 50) {
        state.asked.clear();
        break;
      }
    } while (state.asked.has(key));
    
    // Store the question
    state.asked.add(key);
    state.question = { a, b, ans: a * b };
    
    // Update UI
    dom.question.textContent = `${a} × ${b} = ?`;
    dom.answer.value = '';
    dom.feedback.className = 'feedback';
    
    updateProgressBar();
    
    // Start timer if in challenge mode
    if (state.mode === 'challenge' && !state.timer) {
      startTimer();
    }
  };

  // Timer functions
  const startTimer = () => {
    if (state.timer) {
      clearInterval(state.timer);
    }
    
    state.timeLeft = state.timeLimit;
    updateTimeDisplay();
    
    state.timer = setInterval(() => {
      state.timeLeft--;
      updateTimeDisplay();
      
      if (state.timeLeft <= 0) {
        clearInterval(state.timer);
        state.timer = null;
        finish(true);
      }
    }, 1000);
  };

  const stopTimer = () => {
    if (state.timer) {
      clearInterval(state.timer);
      state.timer = null;
    }
  };

  const updateTimeDisplay = () => {
    dom.current.textContent = state.mode === 'challenge' 
      ? `${state.timeLeft}s (chế độ)` 
      : (state.table ? '—' : '-');
  };

  // UI updates
  const updateProgressBar = () => {
    const percentage = Math.min(100, Math.round((state.answeredCount / state.target) * 100));
    dom.progressBar.style.width = `${percentage}%`;
  };

  const updateUI = () => {
    dom.score.textContent = state.score;
    dom.correct.textContent = state.correct;
    dom.current.textContent = state.table 
      ? (state.table === 'mixed' ? 'Tổng hợp' : `Bảng ${state.table}`) 
      : '-';
    
    updateProgressBar();
  };

  // Answer checking
  const checkAnswer = () => {
    if (!state.question || state.waiting) return;
    
    const answer = Number(dom.answer.value);
    if (!Number.isFinite(answer)) {
      showFeedback('Vui lòng nhập đáp án', false);
      dom.answer.focus();
      return;
    }
    
    state.waiting = true;
    state.answeredCount++;
    
    if (answer === state.question.ans) {
      // Correct answer
      state.score += 10;
      state.correct++;
      
      showFeedback('Chính xác! +10', true);
      playTone([523, 659, 784], 0.24);
      
      // Check if table is completed
      if (state.answeredCount >= state.target) {
        safeLocalStorage.setItem(`mh_completed_${state.table}`, '1');
        showFeedback(`Hoàn thành ${state.table === 'mixed' ? 'tổng hợp' : 'bảng ' + state.table}! 🎉`, true);
        triggerConfetti();
      }
    } else {
      // Wrong answer
      showFeedback(`Sai — Đáp án đúng: ${state.question.ans}`, false);
      playTone([220], 0.12);
    }
    
    updateUI();
    
    // Next question after delay
    const delay = state.reducedMotion ? 250 : 900;
    setTimeout(() => {
      state.waiting = false;
      newQuestion();
      dom.answer.focus();
    }, delay);
  };

  const skipQuestion = () => {
    if (state.waiting) return;
    
    showFeedback(`Đáp án: ${state.question.ans}`, false);
    
    setTimeout(() => {
      newQuestion();
      dom.answer.focus();
    }, 500);
  };

  // Game completion
  const finish = (timeout = false) => {
    stopTimer();
    
    const totalScore = state.score;
    const playerName = prompt('Nhập tên lưu BXH (để giáo viên theo dõi):') || 'Anon';
    
    // Update leaderboard
    const leaderboard = loadLB();
    leaderboard.push({
      name: playerName,
      score: totalScore,
      date: new Date().toISOString()
    });
    
    leaderboard.sort((a, b) => b.score - a.score);
    saveLB(leaderboard.slice(0, 50));
    renderLB();
    
    alert(timeout 
      ? 'Hết thời gian! Điểm đã lưu tạm thời.' 
      : `Kết thúc! Điểm: ${totalScore}`
    );
    
    resetGameState(false);
  };

  // Reset game
  const resetGameState = (keepTable = true) => {
    stopTimer();
    
    if (!keepTable) {
      state.table = null;
    }
    
    state.question = null;
    state.score = 0;
    state.correct = 0;
    state.answeredCount = 0;
    state.asked.clear();
    
    dom.answer.value = '';
    dom.answer.disabled = !state.table;
    dom.btnCheck.disabled = !state.table;
    dom.btnSkip.disabled = !state.table;
    
    updateUI();
    
    dom.question.textContent = state.table ? 'Sẵn sàng...' : 'Chọn bảng để bắt đầu';
    dom.progressBar.style.width = '0%';
  };

  // Feedback
  const showFeedback = (message, isCorrect) => {
    dom.feedback.textContent = message;
    dom.feedback.className = `feedback ${isCorrect ? 'correct' : 'wrong'} show`;
  };

  // Confetti effect
  const triggerConfetti = () => {
    for (let i = 0; i < 18; i++) {
      const confetti = document.createElement('div');
      
      // Style the confetti
      confetti.style.position = 'fixed';
      confetti.style.width = '10px';
      confetti.style.height = '10px';
      confetti.style.left = `${50 + (Math.random() - 0.5) * 60}%`;
      confetti.style.top = '40%';
      confetti.style.background = ['#60a5fa', '#34d399', '#f97316', '#f43f5e', '#a78bfa'][i % 5];
      confetti.style.borderRadius = (i % 2 ? '50%' : '2px');
      confetti.style.zIndex = '9999';
      confetti.style.opacity = '1';
      confetti.style.transition = 'transform 900ms cubic-bezier(.17,.67,.32,1), opacity 900ms';
      
      // Add to document
      document.body.appendChild(confetti);
      
      // Animate
      setTimeout(() => {
        confetti.style.transform = `translate(${(Math.random() - 0.5) * 400}px, ${Math.random() * 600 + 200}px) rotate(${Math.random() * 540 - 270}deg)`;
        confetti.style.opacity = '0';
      }, 20);
      
      // Remove after animation
      setTimeout(() => {
        if (confetti.parentNode) {
          confetti.parentNode.removeChild(confetti);
        }
      }, 1100);
    }
  };

  // Export CSV
  const exportCSV = () => {
    const leaderboard = loadLB();
    const rows = [['name', 'score', 'date']].concat(
      leaderboard.map(item => [item.name, item.score, item.date])
    );
    
    const csvContent = rows.map(row => 
      row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
    ).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    
    link.href = url;
    link.download = 'mathhub_leaderboard.csv';
    link.click();
    
    URL.revokeObjectURL(url);
  };

  // Print function
  const printPage = () => {
    window.print();
  };

  // Event handlers
  const setupEventListeners = () => {
    // Event delegation for table buttons
    dom.tableSelect.addEventListener('click', (e) => {
      if (e.target.classList.contains('table-btn')) {
        activateButtonForTable(e.target.dataset.table);
      }
    });
    
    // Check answer
    dom.btnCheck.addEventListener('click', checkAnswer);
    
    // Skip question
    dom.btnSkip.addEventListener('click', skipQuestion);
    
    // Enter key to check answer
    dom.answer.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        checkAnswer();
      }
    });
    
    // Settings changes
    dom.modeSelect.addEventListener('change', () => {
      state.mode = dom.modeSelect.value;
    });
    
    dom.targetCount.addEventListener('change', () => {
      state.target = Number(dom.targetCount.value);
      updateProgressBar();
    });
    
    dom.timeLimit.addEventListener('change', () => {
      state.timeLimit = Number(dom.timeLimit.value);
    });
    
    // Button actions
    dom.btnHome.addEventListener('click', () => {
      window.location.href = 'index.html';
    });
    
    dom.btnExportCSV.addEventListener('click', exportCSV);
    dom.btnExportLB.addEventListener('click', exportLBCSV);
    dom.btnClearLB.addEventListener('click', clearLB);
    dom.btnSave.addEventListener('click', saveProgress);
    dom.btnPrint.addEventListener('click', printPage);
    
    dom.btnReset.addEventListener('click', () => {
      if (confirm('Reset game?')) {
        resetGameState(false);
      }
    });
    
    dom.btnImport.addEventListener('click', () => {
      alert('Import: Chức năng nhập sẽ sớm có (cần file đúng định dạng).');
    });
    
    // Accessibility settings
    dom.reducedMotion.addEventListener('change', () => {
      state.reducedMotion = dom.reducedMotion.checked;
    });
    
    dom.soundToggle.addEventListener('change', () => {
      state.soundOn = dom.soundToggle.checked;
    });
  };

  // Initialize the game
  const init = () => {
    setupEventListeners();
    renderLB();
    resetGameState(false);
    
    // Preload question sample
    dom.question.textContent = 'Sẵn sàng để bắt đầu — chọn bảng!';
  };

  // Start the game
  init();
})();
</script>
</body>
</html>