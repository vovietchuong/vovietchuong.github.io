<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MathHub — Bảng Cửu Chương (Pro)</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{
  --bg1: linear-gradient(135deg,#0f172a 0%, #0b1220 100%);
  --card:#ffffff;
  --accent:#6f42c1;
  --accent-2:#4e73df;
  --success:#16a34a;
  --danger:#ef4444;
  --muted:#6b7280;
  --glass: rgba(255,255,255,0.03);
  --glass-2: rgba(255,255,255,0.06);
  --radius:14px;
  --tran: all .22s ease;
  color-scheme: light;
}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
html,body{height:100%;margin:0;background:var(--bg1);color:#e6eef8}
a{color:inherit}
.container{width:100%;max-width:1150px;margin:28px auto;padding:20px;border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));box-shadow:0 20px 60px rgba(2,6,23,0.6);overflow:hidden}
.header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:20px}
.title h1{margin:0;font-size:1.25rem}
.title p{margin:0;color:var(--muted);font-size:0.9rem}
.header-controls{display:flex;gap:8px;align-items:center}
.btn{background:transparent;border:0;color:inherit;padding:8px 12px;border-radius:10px;cursor:pointer;transition:var(--tran);display:inline-flex;gap:8px;align-items:center}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;box-shadow:0 8px 20px rgba(79,70,229,0.12);font-weight:600}
.btn.ghost{background:var(--glass);border:1px solid rgba(255,255,255,0.04)}
.grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.table-select{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:12px}
@media (max-width:720px){.table-select{grid-template-columns:repeat(3,1fr)}}
.table-btn{padding:10px;border-radius:10px;border:0;background:linear-gradient(135deg,#0ea5e9,#3b82f6);color:white;font-weight:600;cursor:pointer;transition:var(--tran)}
.table-btn.secondary{background:linear-gradient(135deg,#f97316,#fb923c)}
.table-btn.large{padding:14px;font-size:1.05rem}
.table-btn.active{outline:3px solid rgba(99,102,241,0.16);transform:translateY(-4px);box-shadow:0 12px 30px rgba(79,70,229,0.12)}
.controls{display:flex;gap:8px;align-items:center;margin-top:12px}
.question-big{text-align:center;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));font-size:2rem;font-weight:700;margin:12px 0;min-height:78px;display:flex;align-items:center;justify-content:center}
.input-answer{width:180px;padding:12px;border-radius:12px;border:2px solid rgba(255,255,255,0.06);background:transparent;color:inherit;font-size:1.2rem;text-align:center}
.input-answer:focus{outline:none;box-shadow:0 8px 28px rgba(99,102,241,0.08);border-color:rgba(99,102,241,0.4)}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
.stat{padding:10px;border-radius:10px;background:var(--glass-2);text-align:center}
.stat .label{font-size:0.85rem;color:var(--muted)}
.stat .value{font-weight:700;font-size:1.3rem;margin-top:6px}
.small-muted{color:var(--muted);font-size:0.9rem}
.progress{height:12px;background:rgba(255,255,255,0.04);border-radius:12px;overflow:hidden;margin-top:8px}
.progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
.feedback{min-height:44px;margin-top:10px;border-radius:8px;padding:10px;font-weight:600;opacity:0;transform:translateY(6px);transition:var(--tran)}
.feedback.show{opacity:1;transform:translateY(0)}
.feedback.correct{background:rgba(16,185,129,0.08);color:var(--success);border:1px solid rgba(16,185,129,0.12)}
.feedback.wrong{background:rgba(239,68,68,0.06);color:var(--danger);border:1px solid rgba(239,68,68,0.10)}
.leaderboard{margin-top:12px}
.leaderboard ol{margin:0;padding-left:18px}
.kv{display:flex;justify-content:space-between}
.footer{margin-top:16px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}

/* accessible focus */
.table-btn:focus, .btn:focus, .input-answer:focus{outline:3px solid rgba(99,102,241,0.12)}

/* small screens */
@media (max-width:420px){
  .input-answer{width:120px}
  .table-select{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="container" role="application" aria-label="MathHub Bảng Cửu Chương Pro">
  <div class="header">
    <div class="brand">
      <div class="logo">MH</div>
      <div class="title">
        <h1>Bảng Cửu Chương — MathHub</h1>
        <p>Học, luyện, và thi thử — chuyên nghiệp cho giáo viên</p>
      </div>
    </div>
    <div class="header-controls">
      <button class="btn ghost" id="btn-import"><i class="fas fa-file-import"></i> Import</button>
      <button class="btn ghost" id="btn-export"><i class="fas fa-file-export"></i> Export CSV</button>
      <button class="btn ghost" id="btn-reset"><i class="fas fa-sync"></i> Reset</button>
      <button class="btn primary" id="btn-home"><i class="fas fa-home"></i> Trang chủ</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="small-muted">Chọn bảng hoặc 'Tổng hợp'</div>
      <div class="table-select" id="table-select">
        <button class="table-btn" data-table="2">2</button>
        <button class="table-btn" data-table="3">3</button>
        <button class="table-btn" data-table="4">4</button>
        <button class="table-btn" data-table="5">5</button>
        <button class="table-btn" data-table="6">6</button>
        <button class="table-btn" data-table="7">7</button>
        <button class="table-btn" data-table="8">8</button>
        <button class="table-btn" data-table="9">9</button>
        <button class="table-btn" data-table="10">10</button>
        <button class="table-btn secondary" data-table="mixed">Tổng hợp</button>
      </div>

      <div class="row">
        <div style="flex:1">
          <div class="question-big" id="question">Chọn bảng để bắt đầu</div>
          <div style="display:flex;justify-content:center;gap:8px;align-items:center">
            <input id="answer" class="input-answer" type="number" placeholder="Đáp án" aria-label="đáp án" disabled>
            <button class="btn primary" id="btn-check" disabled><i class="fas fa-check"></i> Kiểm tra</button>
            <button class="btn ghost" id="btn-skip" disabled><i class="fas fa-forward"></i> Bỏ qua</button>
          </div>
          <div id="feedback" class="feedback" role="status" aria-live="polite"></div>
        </div>
      </div>

      <div class="row" style="margin-top:12px;align-items:center;justify-content:space-between">
        <div class="stats" style="flex:1">
          <div class="stat"><div class="label">Điểm</div><div class="value" id="score">0</div></div>
          <div class="stat"><div class="label">Đúng</div><div class="value" id="correct">0</div></div>
          <div class="stat"><div class="label">Bảng</div><div class="value" id="current">-</div></div>
        </div>
      </div>

      <div class="progress" aria-hidden="true"><i id="progressBar" style="width:0%"></i></div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <label class="small-muted">Số câu hoàn thành cho 1 bảng:</label>
        <select id="targetCount" class="input-answer" style="width:140px;height:auto;padding:8px">
          <option value="5">5</option><option value="10" selected>10</option><option value="20">20</option>
        </select>
      </div>
    </div>

    <div class="card" aria-label="Bảng điều khiển">
      <div class="small-muted">Cài đặt nhanh</div>
      <div style="margin-top:8px">
        <label class="small-muted">Chế độ</label>
        <select id="modeSelect" class="input-answer" style="width:100%">
          <option value="practice">Luyện tập (không giới hạn)</option>
          <option value="challenge">Thử thách (thời gian)</option>
        </select>
      </div>
      <div style="margin-top:8px">
        <label class="small-muted">Thời gian (giây) — chỉ chế độ thử thách</label>
        <input id="timeLimit" type="number" class="input-answer" value="60" min="10" style="width:100%">
      </div>

      <div style="margin-top:12px">
        <h4 style="margin:0 0 6px 0">BXH</h4>
        <div class="leaderboard card" style="padding:10px">
          <ol id="leaderboard"></ol>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn ghost" id="btn-export-csv"><i class="fas fa-file-csv"></i> Xuất CSV</button>
            <button class="btn ghost" id="btn-clear-lb"><i class="fas fa-trash"></i> Xóa BXH</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <h4 style="margin:0 0 6px 0">Giao diện & Trợ năng</h4>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <label class="small-muted">Giảm hoạt ảnh</label>
          <input id="reducedMotion" type="checkbox" />
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <label class="small-muted">Bật âm</label>
          <input id="soundToggle" type="checkbox" checked />
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="small-muted">Phiên bản Pro — MathHub | Giáo viên: Thầy Chương</div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn ghost" id="btn-print"><i class="fas fa-print"></i> In</button>
      <button class="btn primary" id="btn-save">Lưu tiến trình</button>
    </div>
  </div>
</div>

<script>
/* Professional multiplication table game
   Features added:
   - Settings (mode/time)
   - Leaderboard (localStorage) with CSV export
   - Import/Export, Save progress, Print
   - Accessibility considerations
   - Smooth animations, confetti, sounds (web audio)
*/
(() => {
  // State
  const state = {
    table: null, // number or 'mixed'
    question: null, // {a,b,ans}
    score: 0,
    correct: 0,
    answeredCount: 0,
    target: Number(document.getElementById('targetCount')?.value || 10),
    mode: 'practice',
    timeLimit: Number(document.getElementById('timeLimit')?.value || 60),
    timeLeft: null,
    timer: null,
    waiting: false,
    asked: new Set(),
    reducedMotion: false,
    soundOn: true
  };

  // DOM
  const dom = {
    tableBtns: document.querySelectorAll('.table-btn'),
    question: document.getElementById('question'),
    answer: document.getElementById('answer'),
    btnCheck: document.getElementById('btn-check'),
    btnSkip: document.getElementById('btn-skip'),
    score: document.getElementById('score'),
    correct: document.getElementById('correct'),
    current: document.getElementById('current'),
    progressBar: document.getElementById('progressBar'),
    feedback: document.getElementById('feedback'),
    targetCount: document.getElementById('targetCount'),
    modeSelect: document.getElementById('modeSelect'),
    timeLimit: document.getElementById('timeLimit'),
    leaderboard: document.getElementById('leaderboard'),
    btnHome: document.getElementById('btn-home'),
    btnExportCSV: document.getElementById('btn-export'),
    btnImport: document.getElementById('btn-import'),
    btnReset: document.getElementById('btn-reset'),
    btnExportLB: document.getElementById('btn-export-csv'),
    btnClearLB: document.getElementById('btn-clear-lb'),
    btnSave: document.getElementById('btn-save'),
    btnPrint: document.getElementById('btn-print'),
    reducedMotion: document.getElementById('reducedMotion'),
    soundToggle: document.getElementById('soundToggle')
  };

  // Audio
  let audioCtx=null;
  function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
  function playTone(freqs=[440], dur=0.12){
    if(!state.soundOn) return;
    try{
      ensureAudio();
      const now = audioCtx.currentTime;
      const g = audioCtx.createGain(); g.gain.setValueAtTime(0.001,now); g.gain.exponentialRampToValueAtTime(0.2, now+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
      g.connect(audioCtx.destination);
      freqs.forEach((f,i)=>{
        const o = audioCtx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(f, now + i*0.02);
        o.connect(g); o.start(now + i*0.02); o.stop(now + dur + i*0.02);
      });
    }catch(e){ console.log('Audio not supported', e); }
  }

  // Utilities
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function saveLB(list){ localStorage.setItem('mh_lbh', JSON.stringify(list)); }
  function loadLB(){ const r = localStorage.getItem('mh_lbh'); return r? JSON.parse(r): []; }
  function saveProgress(){
    const payload = { table: state.table, score: state.score, correct: state.correct, answeredCount: state.answeredCount };
    localStorage.setItem('mh_progress', JSON.stringify(payload));
    alert('Đã lưu tiến trình vào localStorage');
  }
  function loadProgress(){
    const raw = localStorage.getItem('mh_progress'); if(!raw){ alert('Không có tiến trình'); return; }
    const p = JSON.parse(raw);
    state.table = p.table; state.score = p.score; state.correct = p.correct; state.answeredCount = p.answeredCount;
    updateUI();
    if(state.table) activateButtonForTable(state.table);
    alert('Đã tải tiến trình');
  }

  // Leaderboard render and export
  function renderLB(){
    const list = loadLB();
    dom.leaderboard.innerHTML = '';
    list.slice(0,10).forEach((it,i)=>{
      const li = document.createElement('li'); li.innerHTML = `<span>${i+1}. <strong>${it.name}</strong></span><span>${it.score}</span>`;
      dom.leaderboard.appendChild(li);
    });
  }
  function exportLBCSV(){
    const list = loadLB();
    if(!list.length){ alert('BXH trống'); return; }
    const rows = [['rank','name','score','date']].concat(list.map((l,idx)=>[idx+1, l.name, l.score, l.date]));
    const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download = 'mathhub_leaderboard.csv'; a.click(); URL.revokeObjectURL(url);
  }
  function clearLB(){ if(confirm('Xóa BXH?')){ localStorage.removeItem('mh_lbh'); renderLB(); } }

  // Table activation
  function activateButtonForTable(table){
    dom.tableBtns.forEach(b=> b.classList.toggle('active', b.dataset.table==table));
    state.table = table;
    state.asked.clear();
    state.answeredCount = 0;
    state.target = Number(dom.targetCount.value)||10;
    state.mode = dom.modeSelect.value;
    state.timeLimit = Number(dom.timeLimit.value) || 60;
    dom.current.textContent = table==='mixed' ? 'Tổng hợp' : 'Bảng '+table;
    dom.answer.disabled = false; dom.btnCheck.disabled = false; dom.btnSkip.disabled = false; dom.answer.focus();
    newQuestion();
  }

  // New question generation (avoid repeats)
  function newQuestion(){
    if(!state.table) return;
    let a,b,key,attempts=0;
    do{
      if(state.table === 'mixed'){
        a = randInt(2,10); b = randInt(1,10);
      } else {
        a = Number(state.table); b = randInt(1,10);
      }
      key = `${a}x${b}`; attempts++;
      if(attempts>50){ state.asked.clear(); break; }
    } while(state.asked.has(key));
    state.asked.add(key);
    state.question = {a,b,ans:a*b};
    dom.question.textContent = `${a} × ${b} = ?`;
    dom.answer.value = '';
    dom.feedback.className = 'feedback';
    updateProgress();
    if(state.mode === 'challenge' && !state.timer){
      startTimer();
    }
  }

  // Timer
  function startTimer(){
    if(state.timer) clearInterval(state.timer);
    state.timeLeft = state.timeLimit;
    updateTimeDisplay();
    state.timer = setInterval(()=>{
      state.timeLeft--;
      updateTimeDisplay();
      if(state.timeLeft<=0){ clearInterval(state.timer); state.timer=null; finish(true); }
    },1000);
  }
  function stopTimer(){ if(state.timer){ clearInterval(state.timer); state.timer=null; } }
  function updateTimeDisplay(){ document.getElementById('current').textContent = dom.modeSelect.value === 'challenge' ? `${state.timeLeft}s (chế độ)` : (state.table? '—': '-'); }

  // Progress / UI updates
  function updateProgress(){
    const pct = Math.min(100, Math.round((state.answeredCount/state.target)*100));
    dom.progressBar.style.width = pct + '%';
  }
  function updateUI(){
    dom.score.textContent = state.score;
    dom.correct.textContent = state.correct;
    dom.current.textContent = state.table ? (state.table==='mixed' ? 'Tổng hợp' : 'Bảng '+state.table) : '-';
    updateProgress();
  }

  // Answer check
  function checkAnswer(){
    if(!state.question || state.waiting) return;
    const val = Number(dom.answer.value);
    if(!Number.isFinite(val)){ showFeedback('Vui lòng nhập đáp án', false); dom.answer.focus(); return; }
    state.waiting = true;
    state.answeredCount++;
    if(val === state.question.ans){
      // correct
      state.score += 10;
      state.correct++;
      showFeedback('Chính xác! +10', true);
      playTone([523,659,784],0.24);
      // completed table?
      if(state.answeredCount >= state.target){
        // mark completed visually (store)
        localStorage.setItem(`mh_completed_${state.table}`, '1');
        showFeedback(`Hoàn thành ${state.table==='mixed'?'tổng hợp':'bảng '+state.table}! 🎉`, true);
        confetti();
      }
    } else {
      // wrong
      showFeedback(`Sai — Đáp án đúng: ${state.question.ans}`, false);
      playTone([220],0.12);
    }
    updateUI();
    setTimeout(()=>{ state.waiting=false; newQuestion(); dom.answer.focus(); }, state.reducedMotion? 250 : 900);
  }

  // Skip
  function skipQuestion(){ if(state.waiting) return; showFeedback(`Đáp án: ${state.question.ans}`, false); setTimeout(()=>{ newQuestion(); dom.answer.focus(); },500); }

  // Finish (end of challenge if time out)
  function finish(timeout=false){
    stopTimer();
    const total = state.score;
    const name = prompt('Nhập tên lưu BXH (để giáo viên theo dõi):') || 'Anon';
    const list = loadLB(); list.push({name,score:total,date:new Date().toISOString()}); list.sort((a,b)=>b.score-a.score); saveLB(list.slice(0,50)); renderLB();
    alert(timeout ? 'Hết thời gian! Điểm đã lưu tạm thời.' : `Kết thúc! Điểm: ${total}`);
    resetGameState(false);
  }

  // Reset
  function resetGameState(keepTable=true){
    stopTimer();
    if(!keepTable) state.table=null;
    state.question=null; state.score=0; state.correct=0; state.answeredCount=0; state.asked.clear();
    dom.answer.value=''; dom.answer.disabled = !state.table;
    dom.btnCheck.disabled = !state.table; dom.btnSkip.disabled = !state.table;
    updateUI();
    dom.question.textContent = state.table ? 'Sẵn sàng...' : 'Chọn bảng để bắt đầu';
    dom.progressBar.style.width='0%';
  }

  // Feedback UI
  function showFeedback(msg, ok){
    dom.feedback.textContent = msg;
    dom.feedback.className = 'feedback ' + (ok? 'correct':'wrong') + ' show';
  }

  // Confetti (lightweight)
  function confetti(){
    for(let i=0;i<18;i++){
      const d=document.createElement('div'); d.style.position='fixed'; d.style.width='10px'; d.style.height='10px';
      d.style.left = `${50+ (Math.random()-0.5)*60}%`; d.style.top='40%'; d.style.background = ['#60a5fa','#34d399','#f97316','#f43f5e','#a78bfa'][i%5];
      d.style.borderRadius = (i%2? '50%':'2px'); d.style.zIndex = 9999; d.style.opacity=1;
      d.style.transition = 'transform 900ms cubic-bezier(.17,.67,.32,1),opacity 900ms';
      document.body.appendChild(d);
      setTimeout(()=>{ d.style.transform = `translate(${(Math.random()-0.5)*400}px, ${Math.random()*600 + 200}px) rotate(${Math.random()*540-270}deg)`; d.style.opacity=0; },20);
      setTimeout(()=>d.remove(),1100);
    }
  }

  // Export/Import CSV & Export game as HTML? (export LB only)
  function exportCSV(){
    const rows = [['name','score','date']].concat(loadLB().map(r=>[r.name,r.score,r.date]));
    const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\\n');
    const blob = new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='mathhub_leaderboard.csv'; a.click(); URL.revokeObjectURL(url);
  }

  // Print
  function printPage(){ window.print(); }

  // Event bindings
  dom.tableBtns.forEach(b=> b.addEventListener('click', ()=> activateButtonForTable(b.dataset.table)));
  dom.btnCheck.addEventListener('click', checkAnswer);
  dom.btnSkip.addEventListener('click', skipQuestion);
  dom.answer.addEventListener('keydown', (e)=>{ if(e.key==='Enter') checkAnswer(); });
  dom.modeSelect.addEventListener('change', ()=>{ state.mode = dom.modeSelect.value; });
  dom.targetCount.addEventListener('change', ()=>{ state.target = Number(dom.targetCount.value); updateProgress(); });
  dom.timeLimit.addEventListener('change', ()=> state.timeLimit = Number(dom.timeLimit.value));
  dom.btnHome.addEventListener('click', ()=> window.location.href='index.html');
  dom.btnExportCSV.addEventListener('click', exportCSV);
  dom.btnExportLB.addEventListener('click', exportLBCSV);
  dom.btnClearLB.addEventListener('click', clearLB);
  dom.btnSave.addEventListener('click', saveProgress);
  dom.btnPrint.addEventListener('click', printPage);
  dom.btnReset.addEventListener('click', ()=>{ if(confirm('Reset game?')) resetGameState(false); });
  dom.btnImport.addEventListener('click', ()=>{ alert('Import: Chức năng nhập sẽ sớm có (cần file đúng định dạng).'); });
  dom.reducedMotion.addEventListener('change', ()=> state.reducedMotion = dom.reducedMotion.checked);
  dom.soundToggle.addEventListener('change', ()=> state.soundOn = dom.soundToggle.checked);

  // init
  renderLB();
  resetGameState(false);
  // preload question sample
  dom.question.textContent = 'Sẵn sàng để bắt đầu — chọn bảng!';
})();
</script>
</body>
</html>
