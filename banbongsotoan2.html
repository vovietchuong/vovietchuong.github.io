<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üéà B·∫Øn B√≥ng S·ªë ‚Äì B·∫£n N√¢ng C·∫•p</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1:#0ea5e9; --bg-2:#7dd3fc; --panel:#ffffffee; --ink:#0f172a;
      --brand:#f97316; --ok:#10b981; --bad:#ef4444; --muted:#475569;
      --shadow:0 10px 25px rgba(2, 6, 23, .15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink);
      background: linear-gradient(180deg, var(--bg-1), var(--bg-2)); display:flex; flex-direction:column; overflow:hidden}
    /* HEADER */
    .topbar{position:relative; z-index:3; display:flex; gap:12px; align-items:center; justify-content:space-between; padding:10px 14px; background:var(--panel); box-shadow: var(--shadow)}
    .brand{display:flex; align-items:center; gap:10px}
    .brand h1{font-size:clamp(18px, 4vw, 26px); margin:0; color:var(--brand)}
    .pill{background:#eef2ff; color:#3730a3; font-weight:800; padding:6px 10px; border-radius:999px;}

    .stats{display:flex; gap:10px; flex-wrap:wrap}
    .stat{background:#ecfeff; border:2px solid #67e8f9; padding:6px 10px; border-radius:14px; font-weight:800; min-width:90px; text-align:center}
    .heart{color:#ef4444}
    .timer{position:relative}
    .timer-bar{position:absolute; left:0; bottom:-3px; height:3px; background:#0ea5e9; width:100%; border-radius:3px}

    /* AREA */
    #gameArea{position:relative; flex:1; overflow:hidden; background:linear-gradient(180deg, #ffffff33, #ffffff14)}
    #pauseOverlay{position:absolute; inset:0; background:rgba(2,6,23,0.7); display:none; align-items:center; justify-content:center; z-index:8; flex-direction:column; gap:20px; color:white; font-weight:800; font-size:28px; backdrop-filter:blur(4px)}
    #pauseOverlay.show{display:flex}

    /* BALLOON */
    .balloon{position:absolute; top:100%; width:90px; height:110px; display:flex; align-items:center; justify-content:center; padding:8px; cursor:pointer; filter:drop-shadow(0 6px 12px rgba(0,0,0,.15)); user-select:none; transition:transform 0.2s}
    .balloon.paused{animation-play-state:paused}
    .balloon .txt{font-size:18px; font-weight:900; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.5)}
    .pop{animation:pop .45s both}
    @keyframes pop{0%{transform:scale(1);opacity:1}50%{transform:scale(1.5);opacity:.8}100%{transform:scale(0);opacity:0}}

    /* CONTROLS */
    .controls{z-index:2; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; padding:10px; background:var(--panel); box-shadow: var(--shadow)}
    input[type=number]{font-size:18px; padding:10px 14px; width:140px; border-radius:12px; border:2px solid #38bdf8; text-align:center}
    button{border:0; padding:10px 16px; border-radius:12px; font-weight:900; cursor:pointer; box-shadow: var(--shadow); transition:all 0.2s}
    button:active{transform:scale(0.96)}
    .btn-primary{background:linear-gradient(180deg, #fb923c, #f97316); color:#fff}
    .btn-green{background:linear-gradient(180deg, #22c55e, #16a34a); color:#fff}
    .btn-muted{background:#e2e8f0}
    .btn-danger{background:linear-gradient(180deg,#ef4444,#dc2626); color:#fff}

    /* PANEL SETTINGS */
    .dock{position:absolute; right:10px; top:10px; display:flex; gap:8px; flex-direction:column; z-index:5}
    .chip{padding:8px 12px; border-radius:999px; background:#fff; font-weight:800; cursor:pointer; box-shadow: var(--shadow); display:flex; align-items:center; gap:6px; transition:all 0.2s}
    .chip:hover{transform:translateY(-2px); box-shadow:0 12px 20px rgba(2,6,23,0.2)}
    .chip.active{background:#3730a3; color:#fff}
    .chip.pause-active{background:#f97316; color:#fff}
    .chip-icon{font-size:16px}

    .modal{position:fixed; inset:0; background:rgba(2,6,23,.4); display:none; align-items:center; justify-content:center; z-index:10; backdrop-filter:blur(4px)}
    .modal.show{display:flex}
    .card{width:min(720px, 92vw); background:#fff; border-radius:20px; padding:16px; box-shadow: var(--shadow)}
    .grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(180px,1fr)); gap:12px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .range{width:100%}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; background:#0f172a; color:#fff; padding:2px 6px; border-radius:6px}

    /* FEEDBACK */
    .toast{position:fixed; left:50%; top:18%; transform:translate(-50%,-50%); font-weight:900; font-size:32px; pointer-events:none; opacity:0; transition:opacity .2s; z-index:5}
    .toast.ok{color:var(--ok); text-shadow:0 2px 0 #fff}
    .toast.bad{color:var(--bad); text-shadow:0 2px 0 #fff}

    /* HOME BUTTON */
    .home-btn{position:absolute; left:10px; top:10px; z-index:5; padding:8px 12px; border-radius:999px; background:#fff; font-weight:800; cursor:pointer; box-shadow: var(--shadow); display:flex; align-items:center; gap:6px; transition:all 0.2s}
    .home-btn:hover{transform:translateY(-2px); box-shadow:0 12px 20px rgba(2,6,23,0.2)}

    /* RESPONSIVE */
    @media (max-width:480px){ 
      .balloon{width:76px; height:96px} 
      .balloon .txt{font-size:16px} 
      .stats{gap:6px}
      .stat{min-width:70px; font-size:14px; padding:4px 8px}
      .dock{flex-direction:row; bottom:10px; top:auto; right:50%; transform:translateX(50%)}
      .home-btn{top:auto; bottom:10px; left:50%; transform:translateX(-50%)}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="pill">L·ªõp 2</span>
      <h1>üéØ B·∫Øn B√≥ng S·ªë ‚Äì B·∫£n N√¢ng C·∫•p</h1>
    </div>
    <div class="stats">
      <div class="stat">ƒêi·ªÉm: <span id="score">0</span></div>
      <div class="stat">ƒê√∫ng: <span id="correct">0</span></div>
      <div class="stat">Sai: <span id="wrong">0</span></div>
      <div class="stat timer">Th·ªùi gian: <span id="time">60</span>s<div class="timer-bar" id="timebar"></div></div>
      <div class="stat">M·∫°ng: <span id="lives">3</span> <span class="heart">‚ù§</span></div>
      <div class="stat">K·ª∑ l·ª•c: <span id="best">0</span></div>
    </div>
  </header>

  <div id="gameArea">
    <div id="pauseOverlay">
      <div>‚è∏Ô∏è TR√í CH∆†I ƒêANG T·∫†M D·ª™NG</div>
      <button class="btn-green" id="btnResumeFromOverlay">Ti·∫øp t·ª•c ch∆°i</button>
    </div>
  </div>

  <!-- Home Button -->
  <button id="btnHome" class="home-btn">üè† Trang ch·ªß</button>

  <!-- Control Dock -->
  <div class="dock">
    <button id="btnPause" class="chip"><span class="chip-icon">‚è∏</span><span class="chip-text">T·∫°m d·ª´ng</span></button>
    <button id="btnSettings" class="chip"><span class="chip-icon">‚öôÔ∏è</span><span class="chip-text">C√†i ƒë·∫∑t</span></button>
    <button id="btnMute" class="chip"><span class="chip-icon">üîä</span><span class="chip-text">√Çm thanh</span></button>
  </div>

  <section class="controls">
    <input type="number" id="answer" placeholder="Nh·∫≠p ƒë√°p √°n" />
    <button class="btn-primary" id="btnShoot">B·∫Øn!</button>
    <button class="btn-green" id="btnStart">B·∫Øt ƒë·∫ßu</button>
    <button class="btn-danger" id="btnReset">Ch∆°i l·∫°i</button>
  </section>

  <!-- MODAL SETTINGS -->
  <div class="modal" id="settingsModal">
    <div class="card">
      <h2 style="margin:4px 0 12px">‚öôÔ∏è C√†i ƒë·∫∑t luy·ªán t·∫≠p</h2>
      <div class="grid">
        <div class="row"><label>ƒê·ªô kh√≥</label>
          <div>
            <button class="chip diff" data-diff="easy">D·ªÖ</button>
            <button class="chip diff" data-diff="medium">TB</button>
            <button class="chip diff" data-diff="hard">Kh√≥</button>
          </div>
        </div>
        <div class="row">
          <label>Ph√©p to√°n</label>
          <div>
            <label><input type="checkbox" class="op" value="+" checked /> C·ªông</label>
            <label><input type="checkbox" class="op" value="-" checked /> Tr·ª´</label>
            <label><input type="checkbox" class="op" value="√ó" /> Nh√¢n (‚â§5)</label>
            <label><input type="checkbox" class="op" value="√∑" /> Chia (tr√≤n)</label>
          </div>
        </div>
        <div class="row">
          <label>Gi·ªõi h·∫°n s·ªë t·ªëi ƒëa</label>
          <input class="range" id="maxN" type="range" min="10" max="100" step="10" value="20" />
          <span id="maxNLabel" class="kbd">20</span>
        </div>
        <div class="row">
          <label>T·ªëc ƒë·ªô b√≥ng</label>
          <input class="range" id="speed" type="range" min="0.3" max="1.5" step="0.1" value="0.7" />
          <span id="speedLabel" class="kbd">0.7x</span>
        </div>
        <div class="row">
          <label>T·∫ßn su·∫•t xu·∫•t hi·ªán</label>
          <input class="range" id="spawnRate" type="range" min="800" max="3000" step="100" value="2000" />
          <span id="spawnRateLabel" class="kbd">2000ms</span>
        </div>
        <div class="row">
          <label>Th·ªùi gian m·ªói v√°n</label>
          <input class="range" id="duration" type="range" min="30" max="180" step="10" value="60" />
          <span id="durationLabel" class="kbd">60s</span>
        </div>
        <div class="row">
          <label>Th√™m th·ªùi gian khi ƒë√∫ng</label>
          <input class="range" id="bonus" type="range" min="0" max="5" step="1" value="1" />
          <span id="bonusLabel" class="kbd">+1s</span>
        </div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
        <button class="btn-muted" id="btnCloseSettings">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ======= STATE =======
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    const ui = {
      area: $('#gameArea'), score: $('#score'), correct: $('#correct'), wrong: $('#wrong'), lives: $('#lives'),
      best: $('#best'), time: $('#time'), timebar: $('#timebar'), ans: $('#answer'), toast: $('#toast'),
      btnShoot: $('#btnShoot'), btnStart: $('#btnStart'), btnReset: $('#btnReset'), btnPause: $('#btnPause'), btnSettings: $('#btnSettings'), btnMute: $('#btnMute'),
      btnHome: $('#btnHome'), modal: $('#settingsModal'), pauseOverlay: $('#pauseOverlay'),
      btnResumeFromOverlay: $('#btnResumeFromOverlay'),
      maxN: $('#maxN'), maxNLabel: $('#maxNLabel'), speed: $('#speed'), speedLabel: $('#speedLabel'),
      duration: $('#duration'), durationLabel: $('#durationLabel'), bonus: $('#bonus'), bonusLabel: $('#bonusLabel'),
      spawnRate: $('#spawnRate'), spawnRateLabel: $('#spawnRateLabel')
    };

    const state = {
      running: false, paused: false, timeLeft: 60, lives: 3,
      score: 0, correct: 0, wrong: 0, combo: 0, best: +localStorage.getItem('bb_best')||0,
      diff: 'easy', ops: ['+','-'], maxN: 20, speed: 0.7, spawnEvery: 2000, bonus: 1, muted: false,
      balloons: [],
      lastSpawn: 0, lastFrame: 0,
      animationFrameId: null
    };
    ui.best.textContent = state.best;

    // ======= SOUND (beeps) =======
    let AC; const beep = (freq=880, dur=0.12, type='sine', vol=0.08) => {
      if(state.muted) return; AC ||= new (window.AudioContext||window.webkitAudioContext)();
      const o = AC.createOscillator(); const g = AC.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(AC.destination);
      o.start(); o.stop(AC.currentTime+dur);
    };

    // ======= HELPERS =======
    const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
    const svgBalloon = (hex) => `url('data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 120\"><defs><radialGradient id=\"g\" cx=\"35%\" cy=\"35%\" r=\"65%\"><stop offset=\"0\" stop-color=\"#fff8\"/><stop offset=\"1\" stop-color=\"${hex}\"/></radialGradient></defs><path fill=\"url(#g)\" d=\"M50 8c22 0 38 20 38 50s-16 50-38 50S12 88 12 58 28 8 50 8z\"/><path fill=\"#0002\" d=\"M45 103c3 4 7 4 10 0\"/></svg>`)}')`;

    const COLORS = ['#f43f5e','#fb923c','#f59e0b','#10b981','#22d3ee','#60a5fa','#a78bfa'];

    function genOp(){
      const op = state.ops[rand(0, state.ops.length-1)];
      let a=0,b=0,res=0,disp='';
      const M = state.maxN;
      if(op === '+'){ a=rand(0,M); b=rand(0,M-a); res=a+b; }
      else if(op === '-') { a=rand(0,M); b=rand(0,a); res=a-b; }
      else if(op === '√ó') { a=rand(0,5); b=rand(0,5); res=a*b; }
      else if(op === '√∑') { b=rand(1,5); res=rand(0,5); a=b*res; }
      disp = `${a} ${op} ${b}`; return {disp, res};
    }

    function spawnBalloon(){
      const {disp, res} = genOp();
      const el = document.createElement('div'); el.className='balloon';
      const color = COLORS[rand(0, COLORS.length-1)];
      el.style.left = Math.min(Math.max(10, rand(0, ui.area.clientWidth-100)), ui.area.clientWidth-100)+ 'px';
      el.style.backgroundImage = svgBalloon(color);
      el.innerHTML = `<div class="txt">${disp}</div>`;
      ui.area.appendChild(el);
      
      // T·ªëc ƒë·ªô b√≥ng ch·∫≠m h∆°n cho d·ªÖ ch∆°i
      state.balloons.push({el, top: 100, v: (Math.random()*0.2 + state.speed*0.5), ans: res});
    }

    function removeBalloon(i, pop=true){
      const b = state.balloons[i]; if(!b) return;
      if(pop){ b.el.classList.add('pop'); setTimeout(()=>b.el.remove(), 350);} else { b.el.remove(); }
      state.balloons.splice(i,1);
    }

    function loseLife(){
      state.lives--; ui.lives.textContent = state.lives; flash('‚àí1 m·∫°ng', 'bad'); beep(220, .15, 'sawtooth', .06);
      if(state.lives<=0) endGame();
    }

    function flash(msg, type='ok'){
      ui.toast.textContent = msg; ui.toast.className = `toast ${type}`; ui.toast.style.opacity = 1;
      setTimeout(()=> ui.toast.style.opacity = 0, 700);
    }

    function updateHUD(){
      ui.score.textContent = state.score;
      ui.correct.textContent = state.correct;
      ui.wrong.textContent = state.wrong;
      ui.time.textContent = Math.max(0, Math.ceil(state.timeLeft));
      ui.timebar.style.width = (state.timeLeft / (+ui.duration.value || state.duration) * 100) + '%';
    }

    function startGame(){
      state.running = true; state.paused=false;
      state.timeLeft = +ui.duration.value || 60; state.lives=3; state.score=0; state.correct=0; state.wrong=0; state.combo=0;
      ui.ans.value=''; ui.ans.focus();
      ui.area.innerHTML=''; state.balloons.length=0; state.lastSpawn=0; state.lastFrame=performance.now();
      
      // C·∫≠p nh·∫≠t giao di·ªán n√∫t t·∫°m d·ª´ng
      updatePauseButton();
      
      // ·∫®n overlay t·∫°m d·ª´ng n·∫øu c√≥
      ui.pauseOverlay.classList.remove('show');
      
      // Kh·ªüi ƒë·ªông game loop
      if (state.animationFrameId) {
        cancelAnimationFrame(state.animationFrameId);
      }
      loop(performance.now());
    }

    function endGame(){
      state.running=false; 
      flash(`H·∫øt gi·ªù! ƒêi·ªÉm: ${state.score}`, 'bad');
      if(state.score>state.best){ 
        state.best=state.score; 
        localStorage.setItem('bb_best', state.best); 
        ui.best.textContent = state.best; 
      }
      
      // H·ªßy animation frame khi k·∫øt th√∫c game
      if (state.animationFrameId) {
        cancelAnimationFrame(state.animationFrameId);
        state.animationFrameId = null;
      }
    }

    function pauseGame() {
      if(!state.running || state.paused) return;
      
      state.paused = true;
      beep(440, 0.1);
      
      // Hi·ªÉn th·ªã overlay t·∫°m d·ª´ng
      ui.pauseOverlay.classList.add('show');
      
      // D·ª´ng t·∫•t c·∫£ animation c·ªßa b√≥ng
      state.balloons.forEach(b => {
        b.el.classList.add('paused');
      });
      
      // C·∫≠p nh·∫≠t giao di·ªán n√∫t t·∫°m d·ª´ng
      updatePauseButton();
      
      // H·ªßy animation frame ƒë·ªÉ ti·∫øt ki·ªám t√†i nguy√™n
      if (state.animationFrameId) {
        cancelAnimationFrame(state.animationFrameId);
        state.animationFrameId = null;
      }
    }

    function resumeGame() {
      if(!state.running || !state.paused) return;
      
      state.paused = false;
      beep(660, 0.1);
      
      // ·∫®n overlay t·∫°m d·ª´ng
      ui.pauseOverlay.classList.remove('show');
      
      // Ti·∫øp t·ª•c animation c·ªßa b√≥ng
      state.balloons.forEach(b => {
        b.el.classList.remove('paused');
      });
      
      // C·∫≠p nh·∫≠t giao di·ªán n√∫t t·∫°m d·ª´ng
      updatePauseButton();
      
      // Kh·ªüi ƒë·ªông l·∫°i game loop
      state.lastFrame = performance.now();
      if (!state.animationFrameId) {
        state.animationFrameId = requestAnimationFrame(loop);
      }
    }

    function pauseToggle(){ 
      if(!state.running) return;
      
      if(state.paused) {
        resumeGame();
      } else {
        pauseGame();
      }
    }

    function updatePauseButton() {
      if (state.paused) {
        ui.btnPause.querySelector('.chip-icon').textContent = '‚ñ∂Ô∏è';
        ui.btnPause.querySelector('.chip-text').textContent = 'Ti·∫øp t·ª•c';
        ui.btnPause.classList.add('pause-active');
      } else {
        ui.btnPause.querySelector('.chip-icon').textContent = '‚è∏';
        ui.btnPause.querySelector('.chip-text').textContent = 'T·∫°m d·ª´ng';
        ui.btnPause.classList.remove('pause-active');
      }
    }

    function shoot(val){ 
      if(!state.running || state.paused) return; 
      if(Number.isNaN(+val)) return;
      
      // t√¨m b√≥ng c√≥ ƒë√°p √°n ƒë√∫ng g·∫ßn ƒë√°y nh·∫•t
      let idx=-1, minTop=-1000; 
      for(let i=0;i<state.balloons.length;i++){ 
        const b=state.balloons[i]; 
        if(b.ans===+val && b.top>minTop){ 
          idx=i; minTop=b.top; 
        }
      }
      
      if(idx>-1){
        removeBalloon(idx, true); 
        state.correct++; 
        state.combo++; 
        const bonus = 10 + Math.min(20, state.combo*2);
        state.score += bonus; 
        state.timeLeft += (+ui.bonus.value||0); 
        flash(`+${bonus} ƒëi·ªÉm`, 'ok'); 
        beep(880, .08, 'triangle');
      } else { 
        state.wrong++; 
        state.combo=0; 
        state.score = Math.max(0, state.score-2); 
        flash('Tr∆∞·ª£t!', 'bad'); 
        beep(320, .09, 'square'); 
      }
      ui.ans.value=''; 
      ui.ans.focus(); 
      updateHUD();
    }

    function loop(ts){
      if(!state.running || state.paused) return;
      
      state.animationFrameId = requestAnimationFrame(loop);
      const dt = (ts - state.lastFrame); 
      state.lastFrame = ts; 
      
      // time
      state.timeLeft -= dt/1000; 
      if(state.timeLeft<=0){ 
        endGame(); 
        updateHUD(); 
        return; 
      }
      
      // spawn rate adapts by difficulty + performance
      state.lastSpawn += dt; 
      if(state.lastSpawn >= state.spawnEvery){ 
        spawnBalloon(); 
        state.lastSpawn = 0; 
      }
      
      // move balloons - T·ªëc ƒë·ªô ch·∫≠m h∆°n
      for(let i=state.balloons.length-1;i>=0;i--){ 
        const b = state.balloons[i]; 
        b.top -= b.v * (dt/20);  // Gi·∫£m t·ªëc ƒë·ªô di chuy·ªÉn (thay ƒë·ªïi t·ª´ 16 th√†nh 20)
        b.el.style.top = b.top + '%'; 
        
        // Ki·ªÉm tra n·∫øu b√≥ng bay ra kh·ªèi m√†n h√¨nh
        if(b.top < -20){ 
          removeBalloon(i,false); 
          loseLife(); 
        }
      }
      
      updateHUD();
    }

    // ======= EVENTS =======
    ui.btnStart.addEventListener('click', startGame);
    ui.btnReset.addEventListener('click', startGame);
    ui.btnShoot.addEventListener('click', ()=> shoot(+ui.ans.value));
    ui.ans.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); shoot(+ui.ans.value); }});
    ui.btnPause.addEventListener('click', pauseToggle);
    ui.btnResumeFromOverlay.addEventListener('click', resumeGame);
    
    ui.btnMute.addEventListener('click', ()=>{ 
      state.muted = !state.muted; 
      ui.btnMute.querySelector('.chip-icon').textContent = state.muted ? 'üîá' : 'üîä';
      ui.btnMute.querySelector('.chip-text').textContent = state.muted ? 'T·∫Øt √¢m' : '√Çm thanh';
      beep(state.muted ? 440 : 660, 0.1);
    });
    
    // Home button functionality
    ui.btnHome.addEventListener('click', () => {
      if(confirm('B·∫°n c√≥ mu·ªën tr·ªü v·ªÅ trang ch·ªß kh√¥ng? Ti·∫øn tr√¨nh hi·ªán t·∫°i s·∫Ω b·ªã m·∫•t.')) {
        // Th·ª±c t·∫ø c√≥ th·ªÉ chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ch·ªß, ·ªü ƒë√¢y t√¥i ch·ªâ reset game
        window.location.href = '/'; // Thay ƒë·ªïi URL n√†y theo trang ch·ªß th·ª±c t·∫ø
      }
    });

    // click v√†o b√≥ng ƒë·ªÉ autofill ƒë√°p √°n
    $('#gameArea').addEventListener('click', (ev)=>{
      const b = ev.target.closest('.balloon'); 
      if(!b || !state.running || state.paused) return;
      
      // t√¨m b·∫£n ghi
      const i = state.balloons.findIndex(x=>x.el===b); 
      if(i>-1){ 
        ui.ans.value = state.balloons[i].ans; 
        shoot(state.balloons[i].ans); 
      }
    });

    // ======= SETTINGS MODAL =======
    const openSettings = ()=> {
      // T·∫°m d·ª´ng game khi m·ªü c√†i ƒë·∫∑t
      if(state.running && !state.paused) {
        pauseGame();
      }
      ui.modal.classList.add('show');
    }
    
    const closeSettings = ()=> ui.modal.classList.remove('show');
    
    ui.btnSettings.addEventListener('click', openSettings);
    $('#btnCloseSettings').addEventListener('click', closeSettings);

    // controls in modal
    $$('.diff').forEach(btn=> btn.addEventListener('click', ()=>{ 
      $$('.diff').forEach(x=>x.classList.remove('active')); 
      btn.classList.add('active'); 
      state.diff = btn.dataset.diff; 
      const d = {
        easy:{speed:0.7, maxN:20, spawnEvery:2000}, 
        medium:{speed:0.9, maxN:40, spawnEvery:1700}, 
        hard:{speed:1.2, maxN:80, spawnEvery:1400}
      }[state.diff]; 
      ui.speed.value = d.speed; 
      ui.speedLabel.textContent=d.speed+'x'; 
      ui.maxN.value=d.maxN; 
      ui.maxNLabel.textContent=d.maxN; 
      ui.spawnRate.value = d.spawnEvery;
      ui.spawnRateLabel.textContent = d.spawnEvery + 'ms';
      state.speed=+ui.speed.value; 
      state.maxN=+ui.maxN.value; 
      state.spawnEvery = +ui.spawnRate.value;
    }));

    ui.maxN.addEventListener('input', ()=>{ ui.maxNLabel.textContent = ui.maxN.value; state.maxN = +ui.maxN.value;});
    ui.speed.addEventListener('input', ()=>{ ui.speedLabel.textContent = ui.speed.value+'x'; state.speed = +ui.speed.value;});
    ui.spawnRate.addEventListener('input', ()=>{ ui.spawnRateLabel.textContent = ui.spawnRate.value+'ms'; state.spawnEvery = +ui.spawnRate.value;});
    ui.duration.addEventListener('input', ()=>{ ui.durationLabel.textContent = ui.duration.value+'s';});
    ui.bonus.addEventListener('input', ()=>{ ui.bonusLabel.textContent = `+${ui.bonus.value}s`; state.bonus = +ui.bonus.value;});

    $$('.op').forEach(cb=> cb.addEventListener('change', ()=>{ const sel = $$('.op').filter(x=>x.checked).map(x=>x.value); state.ops = sel.length? sel : ['+']; }));

    // init defaults
    (function init(){ 
      ui.ans.setAttribute('inputmode','numeric'); 
      ui.ans.setAttribute('pattern','[0-9]*'); 
      ui.duration.value=60; ui.durationLabel.textContent='60s'; 
      ui.maxN.value=20; ui.maxNLabel.textContent='20'; 
      ui.speed.value=0.7; ui.speedLabel.textContent='0.7x'; 
      ui.spawnRate.value=2000; ui.spawnRateLabel.textContent='2000ms';
      ui.bonus.value=1; ui.bonusLabel.textContent='+1s'; 
      $$('.diff')[0].classList.add('active'); 
      
      // C·∫≠p nh·∫≠t icon cho n√∫t t·∫°m d·ª´ng
      updatePauseButton();
    })();

    // Prevent wheel from changing number on scroll while focused
    ui.ans.addEventListener('wheel', e=> e.target === document.activeElement && e.preventDefault(), {passive:false});
  </script>
</body>
</html>