<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üçé To√°n L·ªõp 1 - C·ªông Tr·ª´ 10 (Pro++)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {margin:0; font-family:'Comic Sans MS', cursive; background:linear-gradient(135deg,#f0f9ff,#e0f7fa); display:flex; align-items:center; justify-content:center; min-height:100vh; padding:10px;}
    .container {background:#fff; border-radius:20px; padding:20px; box-shadow:0 8px 20px rgba(0,0,0,.15); max-width:720px; width:100%; text-align:center; position:relative;}
    h1{color:#ff6b6b; margin:0 0 5px; font-size:2rem;}
    .subtitle{color:#0984e3; margin-bottom:15px}
    .home-btn{position:absolute; left:20px; top:20px; padding:6px 12px; border:none; border-radius:20px; cursor:pointer; background:linear-gradient(145deg,#a29bfe,#6c5ce7); color:#fff; font-weight:bold;}
    .mode-selector{display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin:50px 0 15px}
    .mode-btn{padding:6px 14px; border:none; border-radius:20px; cursor:pointer; font-weight:bold; background:#e3f2fd; color:#1976d2; transition:.3s}
    .mode-btn.active{background:linear-gradient(145deg,#74b9ff,#0984e3); color:#fff;}
    .score-bar{display:flex; justify-content:space-between; align-items:center; background:linear-gradient(145deg,#ffeaa7,#fdcb6e); padding:10px 20px; border-radius:14px; margin-bottom:15px; font-weight:bold; color:#d63031;}
    .stars{display:flex; gap:4px}
    .star{color:#ffeaa7; font-size:1.2rem; transition:.3s}
    .star.filled{color:#fdcb6e; text-shadow:0 0 5px #fdcb6e}
    .question-box{background:#f8f9fa; border-radius:15px; padding:20px; margin:15px 0; box-shadow:inset 0 0 6px rgba(0,0,0,.08)}
    .question{font-size:2.5rem; margin:5px 0; color:#2d3436}
    .illustration{font-size:2rem; margin:10px 0; min-height:40px}
    .answer-display{font-size:2rem; min-height:50px; background:#e3f2fd; padding:8px; border-radius:10px; color:#1976d2; margin:10px 0}
    .answer-buttons{display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-bottom:10px}
    .number-btn{padding:10px; font-size:1.5rem; border:none; border-radius:10px; cursor:pointer; background:linear-gradient(145deg,#74b9ff,#0984e3); color:#fff; transition:.2s}
    .number-btn:active{transform:scale(.95)}
    .control-buttons{display:flex; justify-content:center; gap:10px; margin-bottom:10px}
    .control-btn{padding:10px 18px; border:none; border-radius:10px; font-weight:bold; cursor:pointer;}
    #clear-btn{background:linear-gradient(145deg,#fab1a0,#e17055); color:#fff}
    #submit-btn{background:linear-gradient(145deg,#55efc4,#00b894); color:#2d3436}
    .feedback{font-size:1.2rem; min-height:30px; margin:8px 0; opacity:0; transition:.3s;}
    .feedback.show{opacity:1}
    .correct{color:#00b894}
    .incorrect{color:#d63031}
    .timer{font-weight:bold; color:#2d3436}
    .leaderboard{margin-top:15px; text-align:left; background:#f1f5f9; padding:10px; border-radius:10px;}
    .leaderboard h3{margin:5px 0; color:#0f172a;}
    .leaderboard ol{padding-left:20px;}
    canvas#confetti{position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:10}
    .toggle-time{margin:10px 0;}
  </style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="container">
  <button class="home-btn" id="home"><i class="fas fa-home"></i> Trang ch·ªß</button>
  <h1>üçé To√°n L·ªõp 1</h1>
  <p class="subtitle">C·ªông tr·ª´ trong ph·∫°m vi 10 (Pro++)</p>
  
  <div class="mode-selector">
    <button class="mode-btn active" data-mode="addition">Ch·ªâ c·ªông</button>
    <button class="mode-btn" data-mode="subtraction">Ch·ªâ tr·ª´</button>
    <button class="mode-btn" data-mode="both">C·∫£ hai</button>
  </div>

  <div class="toggle-time">
    <label><input type="checkbox" id="infinite-mode"> ‚è≥ Ch∆°i v√¥ h·∫°n (kh√¥ng gi·ªõi h·∫°n th·ªùi gian)</label>
  </div>
  
  <div class="score-bar">
    <span>ƒêi·ªÉm: <span id="score">0</span></span>
    <span class="timer">‚è± <span id="time">60</span>s</span>
    <div class="stars">
      <span class="star">‚≠ê</span>
      <span class="star">‚≠ê</span>
      <span class="star">‚≠ê</span>
    </div>
  </div>
  
  <div class="question-box">
    <div class="question" id="question">3 + 2 = ?</div>
    <div class="illustration" id="illustration">üçéüçéüçé + üçåüçå</div>
    <div class="answer-display" id="answer-display">?</div>
  </div>
  
  <div class="answer-buttons" id="answer-buttons"></div>
  
  <div class="control-buttons">
    <button class="control-btn" id="clear-btn">X√≥a</button>
    <button class="control-btn" id="submit-btn">Tr·∫£ l·ªùi</button>
  </div>
  
  <div class="feedback" id="feedback"></div>
  <div class="leaderboard" id="leaderboard">
    <h3>üèÜ B·∫£ng x·∫øp h·∫°ng</h3>
    <ol id="leader-list"></ol>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
const fruits=['üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','üçí','üçë'];
const state={mode:'addition',score:0,streak:0,ans:'',question:{},time:60,running:false,infinite:false};
const ui={q:document.getElementById('question'),illus:document.getElementById('illustration'),ans:document.getElementById('answer-display'),score:document.getElementById('score'),stars:document.querySelectorAll('.star'),fb:document.getElementById('feedback'),time:document.getElementById('time'),leader:document.getElementById('leader-list'),chkInf:document.getElementById('infinite-mode')};

// --- Firebase setup ---
const firebaseConfig = {
  apiKey: "AIzaSyAPcaScN-HrCcxiUz_J1QrrREF9sxCfvD8",
  authDomain: "mathhubvn.firebaseapp.com",
  projectId: "mathhubvn",
  storageBucket: "mathhubvn.firebasestorage.app",
  messagingSenderId: "1001364433767",
  appId: "1:1001364433767:web:ae1547dc7d1524a6319dc2",
  measurementId: "G-2YNQZ48JVK"
};

// Kh·ªüi t·∫°o Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function init(){
  genButtons();
  bindMode();
  newGame();
  loadLeaderboardFromFirestore();
  document.getElementById('home').onclick=()=>{
    saveScoreToFirestore();
    window.location.href='index.html';
  };
  document.addEventListener('keydown',handleKey);
  ui.chkInf.onchange=()=>{state.infinite=ui.chkInf.checked; reset();};
}

function genButtons(){
  const box=document.getElementById('answer-buttons'); 
  for(let i=0;i<=9;i++){
    const b=document.createElement('button'); 
    b.textContent=i; 
    b.className='number-btn'; 
    b.onclick=()=>{
      if(state.ans.length<2){
        state.ans+=i; 
        renderAns();
      }
    }; 
    box.appendChild(b);
  }
}

function bindMode(){
  document.querySelectorAll('.mode-btn').forEach(btn=>btn.onclick=()=>{
    document.querySelectorAll('.mode-btn').forEach(x=>x.classList.remove('active')); 
    btn.classList.add('active'); 
    state.mode=btn.dataset.mode; 
    reset();
  });
}

function reset(){
  state.score=0; 
  state.streak=0; 
  state.ans=''; 
  state.time= state.infinite?Infinity:60; 
  update(); 
  newQ(); 
  if(!state.infinite) startTimer(); 
  else state.running=true;
}

function newGame(){
  reset();
}

function newQ(){
  const isAdd= state.mode==='addition' || (state.mode==='both'&&Math.random()>.5); 
  let a,b,op,ans; 
  if(isAdd){
    a=Math.floor(Math.random()*10); 
    b=Math.floor(Math.random()*(10-a)); 
    ans=a+b; 
    op='+';
  } else { 
    a=Math.floor(Math.random()*10)+1; 
    b=Math.floor(Math.random()*a); 
    ans=a-b; 
    op='-'; 
  } 
  state.question={a,b,op,ans}; 
  ui.q.textContent=`${a} ${op} ${b} = ?`; 
  ui.illus.textContent=fruits[a%fruits.length].repeat(a)+(op==='+'?' + ':' ‚àí ')+fruits[b%fruits.length].repeat(b); 
  state.ans=''; 
  renderAns();
}

function renderAns(){
  ui.ans.textContent=state.ans||'?';
}

function submit(){
  if(!state.ans) return; 
  const val=+state.ans; 
  if(val===state.question.ans){
    state.score+=10; 
    state.streak=Math.min(3,state.streak+1); 
    feedback('ƒê√∫ng üëè',true); 
    playSound(true); 
    if(state.streak===3) launchConfetti();
  } else {
    feedback(`Sai üò¢. ƒê√∫ng: ${state.question.ans}`,false); 
    state.streak=0; 
    playSound(false);
  } 
  update(); 
  newQ();
}

function feedback(msg,ok){
  ui.fb.textContent=msg; 
  ui.fb.className='feedback show '+(ok?'correct':'incorrect'); 
  setTimeout(()=>ui.fb.className='feedback',1500);
}

function update(){
  ui.score.textContent=state.score; 
  ui.stars.forEach((s,i)=>s.classList.toggle('filled',i<state.streak)); 
  ui.time.textContent= state.infinite? '‚àû': state.time;
}

function startTimer(){
  state.running=true; 
  clearInterval(state.tid); 
  state.tid=setInterval(()=>{
    if(!state.running) return; 
    state.time--; 
    if(state.time<=0){
      end();
    } 
    update();
  },1000);
}

function end(){
  state.running=false; 
  feedback(`‚è∞ H·∫øt gi·ªù! ƒêi·ªÉm: ${state.score}`,false); 
  clearInterval(state.tid); 
  saveScoreToFirestore();
}

// N√∫t
document.getElementById('clear-btn').onclick=()=>{state.ans=''; renderAns();};
document.getElementById('submit-btn').onclick=submit;

// √Çm thanh
function playSound(ok){
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const o=ctx.createOscillator();
  const g=ctx.createGain();
  o.connect(g);
  g.connect(ctx.destination);
  o.type='sine';
  o.frequency.value= ok?660:220;
  g.gain.value=0.1;
  o.start();
  o.stop(ctx.currentTime+0.25);
}

// Confetti
function launchConfetti(){
  const canvas=document.getElementById('confetti');
  const ctx=canvas.getContext('2d');
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
  let pieces=[];
  for(let i=0;i<150;i++){
    pieces.push({
      x:Math.random()*canvas.width,
      y:Math.random()*canvas.height,
      color:`hsl(${Math.random()*360},100%,50%)`,
      ys:Math.random()*3+2,
      size:Math.random()*5+2
    });
  }
  function updateC(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    pieces.forEach(p=>{
      p.y+=p.ys;
      if(p.y>canvas.height)p.y=-10;
      ctx.fillStyle=p.color;
      ctx.fillRect(p.x,p.y,p.size,p.size);
    }); 
    if(state.streak===3) requestAnimationFrame(updateC);
  }
  updateC();
}

// --- L∆∞u ƒëi·ªÉm v√†o Firestore ---
async function saveScoreToFirestore() {
  const currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");
  
  // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
  if (!currentUser.uid) {
    console.log("Ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p, kh√¥ng l∆∞u ƒëi·ªÉm");
    return;
  }
  
  const playerName = currentUser.name || "Kh√°ch";
  const uid = currentUser.uid;

  try {
    // L∆∞u ƒëi·ªÉm v√†o collection scores (theo c·∫•u tr√∫c m·ªõi)
    await db.collection("scores").add({
      userId: uid,
      gameId: "congtrutrongphamvi10",
      gameName: "C·ªông tr·ª´ trong ph·∫°m vi 10",
      score: state.score,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // C≈©ng l∆∞u v√†o leaderboard ƒë·ªÉ hi·ªÉn th·ªã b·∫£ng x·∫øp h·∫°ng
    await db.collection("leaderboard").add({
      userId: uid,
      name: playerName,
      score: state.score,
      game: "congtru10",
      timestamp: new Date()
    });
    
    loadLeaderboardFromFirestore();
  } catch (err) {
    console.error("L·ªói l∆∞u ƒëi·ªÉm:", err);
  }
}

async function loadLeaderboardFromFirestore() {
  try {
    const snapshot = await db.collection("leaderboard")
      .where("game", "==", "congtru10")
      .orderBy("score", "desc")
      .limit(5)
      .get();

    ui.leader.innerHTML = "";
    snapshot.forEach((doc) => {
      const data = doc.data();
      const li = document.createElement("li");
      li.textContent = `${data.name}: ${data.score} ƒëi·ªÉm`;
      ui.leader.appendChild(li);
    });
  } catch (err) {
    console.error("L·ªói t·∫£i b·∫£ng x·∫øp h·∫°ng:", err);
  }
}

// Keyboard input
function handleKey(e){
  if(!state.running)return; 
  if(e.key>='0'&&e.key<='9'){
    if(state.ans.length<2){
      state.ans+=e.key; 
      renderAns();
    }
  } else if(e.key==='Backspace'){
    state.ans=''; 
    renderAns();
  } else if(e.key==='Enter'){
    submit();
  }
}

// L∆∞u ƒëi·ªÉm khi ng∆∞·ªùi d√πng r·ªùi trang
window.addEventListener('beforeunload', function() {
  if (state.score > 0) {
    saveScoreToFirestore();
  }
});

init();
</script>
</body>
</html>